/*! pipeline - v0.0.0 - 2013-12-07
* Copyright (c) 2013 ; Licensed  */
function resolveToPromise(a,b){if(b===a)return a.reject(new TypeError("promise cycle detected")),void 0;if(b instanceof Object){var c;try{c=b.then}catch(d){return a.reject(d),void 0}if(c instanceof Function){var e=!1;c.call(b,function(b){return e?(e=!0,void 0):(resolveToPromise(a,b),void 0)},function(b){return e?(e=!0,void 0):(a.reject(b),void 0)})}}a.fulfill(b)}var assert=require("assert"),_=require("underscore"),Subscriber=function(a){this.init(a)};Subscriber.prototype={init:function(a){return assert(a.next||a.done||a.error),a.next&&(this.next=a.next),a.error&&(this.error=a.error),a.done&&(this.done=a.done),this},next:function(){},error:function(){},done:function(){},onNext:function(a){try{this.next(a)}catch(b){this.onError(b)}},onError:function(a){var b=this.error(a);"undefined"!=typeof b&&this.onNext(b)},onDone:function(){this.done()}};var Pipe=function(a){this.init(a)};Pipe.empty=function(){return new Pipe(function(a){a.onDone()})},Pipe.return=function(a){return new Pipe(function(b){b.onNext(a),b.onDone()})},Pipe.fromArray=function(a){return new Pipe(function(b){for(var c=0;c<a.length;c++)b.onNext(a[c]);b.onDone()})},Pipe.prototype={init:function(a){a&&(this.onSubscribe=a)},isDone:!1,subscribe:function(a){return this.subscribers||(this.subscribers=[]),this.subscribers.push(a),this.onSubscribe&&this.onSubscribe(a),this},subscribeOn:function(a){return this.subscribe(new Subscriber(a))},subscribeNext:function(a){return this.subscribeOn({next:a})},subscribeError:function(a){return this.subscribeOn({error:a})},subscribeDone:function(a){return this.subscribeOn({done:a})},sendNext:function(a){return this.subscribers&&_.each(this.subscribers,function(b){b.onNext(a)}),this},sendError:function(a){return this.subscribers&&_.each(this.subscribers,function(b){b.onError(a)}),this},sendDone:function(){return this.subscribers&&_.each(this.subscribers,function(a){a.onDone()}),this.isDone=!0,delete this.subscribers,this},map:function(a){var b=this,c=new Pipe(function(){b.subscribeOn({next:function(b){c.sendNext(a(b))},error:function(a){c.sendError(a)},done:function(){c.sendDone()}})});return c},mbind:function(a){var b=this,c=new Pipe(function(c){var d=[],e=!1,f=function(a){d.push(a),a.subscribeOn({next:function(a){c.onNext(a)},error:h,done:function(){g(a)}})},g=function(a){var b=d.indexOf(a);b>-1&&d.splice(b,1),i()},h=function(a){c.onError(a)},i=function(){var a=!1;return function(){d.length||!e||a||(a=!0,c.onDone())}}();b.subscribeOn({next:function(b){if(!e){var c=!1,d=function(){c=!0},g=a(b,d);"undefined"==typeof g||c?c&&(e=!0,i()):(assert(g instanceof Pipe),f(g))}},error:h,done:function(){e=!0,i()}})});return c},concat:function(a){var b=this;return new Pipe(function(c){b.subscribeOn({next:function(a){c.onNext(a)},error:function(a){c.onError(a)},done:function(){a.subscribe(c)}})})},filter:function(a){return this.mbind(function(b){return a(b)?Pipe.return(b):Pipe.empty()})},skipWhile:function(a){var b=!1;return this.filter(function(c){return b?!0:a(c)?!1:(b=!0,!0)})},skipUntil:function(a){return this.skipWhile(function(b){return!a(b)})},skip:function(a){return this.skipWhile(function(){return a>0?(a-=1,!0):!1})},takeWhile:function(a){return this.mbind(function(b,c){return a(b)?Pipe.return(b):(c(),Pipe.empty())})},takeUntil:function(a){return this.takeWhile(function(b){return!a(b)})},take:function(a){return this.takeWhile(function(){return a>0?(a-=1,!0):!1})},merge:function(){var a=[].slice.call(arguments);return a.unshift(this),new Pipe(function(b){for(var c=a,d=0;d<a.length;d++)!function(d){var e=a[d];e.subscribeOn({next:function(a){b.onNext(a)},error:function(a){b.onError(a)},done:function(){c.splice(c.indexOf(e),1),0==c.length&&b.onDone()}})}(d)})}};var Promise=function(){this.init()};Promise.prototype=new Pipe,Promise.statusTypePending=1,Promise.statusTypeFulfilled=2,Promise.statusTypeRejected=3,Promise.prototype.status=Promise.statusTypePending,Promise.prototype.value=null,Promise.prototype.reason=null,Promise.prototype.init=function(){},Promise.prototype.then=function(a,b){var c=new Promise,d=function(a,b,c,d){var e;if(a instanceof Function){try{e=a(b)}catch(f){return d.reject(f),void 0}resolveToPromise(d,e)}else d[c?"fulfill":"reject"](b)};return this.subscribeOn({next:function(b){d(a,b,!0,c)},error:function(a){d(b,a,!1,c)}}),c},Promise.prototype.sendNext=function(a){this.status=Promise.statusTypeFulfilled,this.value=a,Pipe.prototype.sendNext.call(this,a),this.sendDone()},Promise.prototype.sendError=function(a){this.status=Promise.statusTypeRejected,this.reason=a,Pipe.prototype.sendError.call(this,a),this.sendDone()},Promise.prototype.fulfill=Promise.prototype.sendNext,Promise.prototype.reject=Promise.prototype.sendError,module.exports={Pipe:Pipe,Subscriber:Subscriber,Promise:Promise};